name: Multi-Platform Build

on:
  push:
    tags:
      - '*'
  workflow_dispatch:

jobs:
  build_android_and_tv_ios_macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '17'
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.8'

      - run: flutter pub get

      # Build macOS
      - name: Build macOS
        run: |
          flutter build macos --dart-define=isTV=false --release
          cd build/macos/Build/Products/Release
          zip -r easyTV-${{ github.ref_name }}-macos.zip *.app

      # Build iOS
      - name: Build iOS
        run: |
          flutter build ios --dart-define=isTV=false --release --no-codesign
          cd build/ios/iphoneos
          mkdir Payload
          mv Runner.app Payload/
          zip -r easyTV-${{ github.ref_name }}.ipa Payload

      - name: Upload ios-macos artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-macos-artifact
          path: |
            build/ios/iphoneos/easyTV-${{ github.ref_name }}.ipa
            build/macos/Build/Products/Release/easyTV-${{ github.ref_name }}-macos.zip

      - name: Decode keystore
        run: |
          echo "${{ secrets.KEYSTORE_FILE }}" | base64 --decode > keystore.jks

      # Build Android Mobile
      - name: Build Android APK Mobile
        run: flutter build apk --dart-define=isTV=false --release
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_ALIAS_PASSWORD: ${{ secrets.KEY_ALIAS_PASSWORD }}
      - name: Rename Android APK
        run: mv build/app/outputs/flutter-apk/app-release.apk build/app/outputs/flutter-apk/easyTV-${{ github.ref_name }}.apk

      # Build Android TV
      - name: Build Android APK TV
        run: flutter build apk --dart-define=isTV=true --release
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_ALIAS_PASSWORD: ${{ secrets.KEY_ALIAS_PASSWORD }}

      - name: Rename Android APK
        run: mv build/app/outputs/flutter-apk/app-release.apk build/app/outputs/flutter-apk/easyTV-${{ github.ref_name }}-tv.apk

      - name: Upload android_and_tv artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-and-tv-artifact
          path: |
            build/app/outputs/flutter-apk/easyTV-${{ github.ref_name }}.apk
            build/app/outputs/flutter-apk/easyTV-${{ github.ref_name }}-tv.apk
            

  build_linux:
    if: false
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.8'
          cache: true

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
          key: ${{ runner.os }}-x64-deps-${{ hashFiles('**/pubspec.yaml') }}
          restore-keys: |
            ${{ runner.os }}-x64-deps-

      - run: |
          sudo apt-get update -y
          sudo apt-get install -y cmake ninja-build libgtk-3-dev libasound2-dev
          sudo apt-get install -y pkg-config libblkid-dev liblzma-dev

      - run: flutter config --enable-linux-desktop
      - run: flutter pub get

      - name: Build Linux x64
        run: |
          flutter build linux --dart-define=isTV=false --release

      - name: Create Linux packages
        run: |
          # 准备打包目录
          mkdir -p packages
          cd build/linux/x64/release/bundle
          
          # 创建传统tar.gz包
          tar -czf ../../../../../packages/easyTV-${{ github.ref_name }}-linux-x64.tar.gz .
          
          # 准备deb包目录结构
          cd ../../../../../
          mkdir -p deb-package/DEBIAN
          mkdir -p deb-package/usr/bin
          mkdir -p deb-package/usr/share/applications
          mkdir -p deb-package/usr/share/icons/hicolor/256x256/apps
          mkdir -p deb-package/usr/share/doc/easytv-live
          
          # 复制应用文件
          cp -r build/linux/x64/release/bundle/* deb-package/usr/bin/
          
          # 创建desktop文件
          cat > deb-package/usr/share/applications/easytv-live.desktop << EOF
          [Desktop Entry]
          Version=1.0
          Type=Application
          Name=Easy TV Live
          Comment=Easy TV Live Application
          Exec=/usr/bin/easy_tv_live
          Icon=easytv-live
          Terminal=false
          Categories=AudioVideo;Video;Player;
          StartupNotify=true
          EOF
          
          # 创建DEBIAN控制文件
          cat > deb-package/DEBIAN/control << EOF
          Package: easytv-live
          Version: ${{ github.ref_name }}
          Section: video
          Priority: optional
          Architecture: amd64
          Depends: libgtk-3-0, libasound2
          Maintainer: Easy TV Live Team
          Description: Easy TV Live Application
           A modern TV live streaming application built with Flutter.
          EOF
          
          # 创建postinst脚本
          cat > deb-package/DEBIAN/postinst << EOF
          #!/bin/bash
          chmod +x /usr/bin/easy_tv_live
          update-desktop-database
          EOF
          chmod 755 deb-package/DEBIAN/postinst
          
          # 构建deb包
          dpkg-deb --build deb-package packages/easyTV-${{ github.ref_name }}-linux-amd64.deb
          
          # 准备rpm包目录结构
          mkdir -p rpm-package/SPECS
          mkdir -p rpm-package/BUILD
          mkdir -p rpm-package/RPMS
          mkdir -p rpm-package/SOURCES
          mkdir -p rpm-package/BUILDROOT/easytv-live-${{ github.ref_name }}-1.x86_64/usr/bin
          mkdir -p rpm-package/BUILDROOT/easytv-live-${{ github.ref_name }}-1.x86_64/usr/share/applications
          
          # 复制文件到rpm构建目录
          cp -r build/linux/x64/release/bundle/* rpm-package/BUILDROOT/easytv-live-${{ github.ref_name }}-1.x86_64/usr/bin/
          cp deb-package/usr/share/applications/easytv-live.desktop rpm-package/BUILDROOT/easytv-live-${{ github.ref_name }}-1.x86_64/usr/share/applications/
          
          # 创建rpm spec文件
          cat > rpm-package/SPECS/easytv-live.spec << EOF
          Name: easytv-live
          Version: ${{ github.ref_name }}
          Release: 1
          Summary: Easy TV Live Application
          License: MIT
          Group: Applications/Multimedia
          BuildArch: x86_64
          Requires: gtk3, alsa-lib
          
          %description
          A modern TV live streaming application built with Flutter.
          
          %files
          /usr/bin/*
          /usr/share/applications/easytv-live.desktop
          
          %post
          chmod +x /usr/bin/easy_tv_live
          update-desktop-database
          
          %changelog
          * $(date +'%a %b %d %Y') Easy TV Live Team - ${{ github.ref_name }}-1
          - Release ${{ github.ref_name }}
          EOF
          
          # 安装rpm-build工具
          sudo apt-get update
          sudo apt-get install -y rpm
          
          # 构建rpm包
          rpmbuild --define "_topdir $(pwd)/rpm-package" -bb rpm-package/SPECS/easytv-live.spec
          cp rpm-package/RPMS/x86_64/*.rpm packages/easyTV-${{ github.ref_name }}-linux-x86_64.rpm
          
          # 创建AppImage
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/share/applications
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
          
          # 复制应用文件
          cp -r build/linux/x64/release/bundle/* AppDir/usr/bin/
          cp deb-package/usr/share/applications/easytv-live.desktop AppDir/usr/share/applications/
          # AppImage需要在根目录有desktop文件
          cp deb-package/usr/share/applications/easytv-live.desktop AppDir/
          
          # 复制图标文件
          if [ -f "assets/images/app_logo.png" ]; then
            cp assets/images/app_logo.png AppDir/easytv-live.png
          else
            echo "Warning: app_logo.png not found in assets/images/"
          fi
          
          # 创建AppRun脚本
          cat > AppDir/AppRun << 'EOF'
          #!/bin/bash
          HERE="$(dirname "$(readlink -f "${0}")")"
          export LD_LIBRARY_PATH="${HERE}/usr/bin/lib:${LD_LIBRARY_PATH}"
          exec "${HERE}/usr/bin/easy_tv_live" "$@"
          EOF
          chmod +x AppDir/AppRun
          
          # 安装FUSE并下载appimagetool
          sudo apt-get install -y fuse libfuse2
          wget -O appimagetool https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool
          
          # 尝试使用FUSE运行，如果失败则使用提取模式
          ./appimagetool AppDir packages/easyTV-${{ github.ref_name }}-linux-x86_64.AppImage || \
          ./appimagetool --appimage-extract-and-run AppDir packages/easyTV-${{ github.ref_name }}-linux-x86_64.AppImage

      - name: Upload linux-x64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-x64-artifact
          path: |
            packages/easyTV-${{ github.ref_name }}-linux-x64.tar.gz
            packages/easyTV-${{ github.ref_name }}-linux-amd64.deb
            packages/easyTV-${{ github.ref_name }}-linux-x86_64.rpm
            packages/easyTV-${{ github.ref_name }}-linux-x86_64.AppImage

  build_windows:
    if: false
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.8'
      - run: flutter config --enable-windows-desktop
      - run: flutter pub get
      - name: Build Windows
        run: |
          flutter build windows --dart-define=isTV=false --release
          cp windows/system32/* build/windows/x64/runner/Release/
          ls -l build/windows/x64/runner/Release
          cd build/windows/x64/runner/Release
          7z a easyTV-${{ github.ref_name }}-windows.zip *

      - name: Upload windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-artifact
          path: |
            build/windows/x64/runner/Release/easyTV-${{ github.ref_name }}-windows.zip

  create_release:
    needs: [ build_linux, build_windows, build_android_and_tv_ios_macos ]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Download artifact artifact
        uses: actions/download-artifact@v4
        with:
          path: release
          merge-multiple: true
      - name: display Release dir
        run: |
          realpath release  
          ls -l release
          pwd

      - name: Upload artifacts to Release
        uses: softprops/action-gh-release@v2
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          release_name: ${{ github.ref_name }}
          draft: true
          prerelease: false
          files: |
            ./release/easyTV-${{ github.ref_name }}.apk
            ./release/ios/iphoneos/easyTV-${{ github.ref_name }}.ipa
            ./release/easyTV-${{ github.ref_name }}-tv.apk
            ./release/easyTV-${{ github.ref_name }}-linux-x64.tar.gz
            ./release/easyTV-${{ github.ref_name }}-linux-amd64.deb
            ./release/easyTV-${{ github.ref_name }}-linux-x86_64.rpm
            ./release/easyTV-${{ github.ref_name }}-linux-x86_64.AppImage
            ./release/easyTV-${{ github.ref_name }}-windows.zip
            ./release/macos/Build/Products/Release/easyTV-${{ github.ref_name }}-macos.zip